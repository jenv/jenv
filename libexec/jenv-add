#!/usr/bin/env bash
# Summary: Add JDK into jenv. A alias name will be generated by parsing "java -version"
# Usage: jenv add /path/to/java_home
set -e
[ -n "$JENV_DEBUG" ] && set -x

# Provide jenv completions
if [ "$1" = "--complete" ]; then
  for d in ${!#}*; do
    [[ -d "$d" ]] && echo $d/
  done
  exit
fi


JENV_JAVAPATH="$1"
JENV_VERSION_FILE=".jenv-version"


if [ $# -eq 2 ]; then
	echo "jenv add alias path/to/java_home is deprecated." 
	echo "Please let jenv generate unique alias name by using"
	echo ""
	echo "	$ jenv add path/to/java_home"                            
	exit 1;
fi;
                            
if [ -f "$JENV_JAVAPATH/bin/java" ];
then     
 
    JAVA_VERSION=`$JENV_JAVAPATH/bin/java -version 2>&1 | head -n 1 | cut -d\" -f 2 ` 
	JAVA_VERSION=${JAVA_VERSION/_/.}   
  
   
	if $JENV_JAVAPATH/bin/java -version 2>&1 | grep -q "HotSpot"; then
		JAVA_PROVIDER="oracle"
	else
	   	if $JENV_JAVAPATH/bin/java -version 2>&1 | grep -q "OpenJDK"; then
			JAVA_PROVIDER="openjdk"
		else   
			if $JENV_JAVAPATH/bin/java -version 2>&1 | grep -q "J9"; then
				JAVA_PROVIDER="ibm"
			else
				JAVA_PROVIDER="other"
			fi;
		fi;  	
	fi;    
	
	if $JENV_JAVAPATH/bin/java -version 2>&1 | grep -q "64-Bit"; then
	   JAVA_PLATFORM="64"
	else   
	   JAVA_PLATFORM="32"
	fi
	
	JENV_VERSION="$JAVA_PROVIDER$JAVA_PLATFORM-$JAVA_VERSION"        
	       
	if [ -h ${JENV_ROOT}/versions/$JENV_VERSION ]; then 
	   echo "There is already a $JENV_VERSION JDK managed by jenv"
	else
 		ln -s  "$JENV_JAVAPATH" "${JENV_ROOT}/versions/$JENV_VERSION" 
 		touch ${JENV_ROOT}/$JENV_VERSION.time   
        echo "$JENV_VERSION added"
		$(jenv-rehash)
	fi
else
	echo "$JENV_JAVAPATH is not a valid path to java installation"
fi
